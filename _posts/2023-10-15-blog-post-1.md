---
title: 'How to combine RADEX and MCMC'
date: 2023-10-16
permalink: /posts/2023/10/RADEX+MCMC/
tags:
  - calculation
  - codes
  - MCMC
---

[RADEX](https://personal.sron.nl/~vdtak/radex/index.shtml) ([van der Tak et al. 2007](https://ui.adsabs.harvard.edu/abs/2007A%26A...468..627V/abstract)) is a simple but powerful code to solve non-LTE radiative transfer, and has been widely used in various astronomical environments. Generally, we use this code to fit the physical parameters of a molecular cloud with multiple transitions of a single molecular species. When fitting the data, we tend to minimize a loss function (or something similar), and MCMC (Markov chain Monte Carlo) is a powerful method to get the global minimum (instead of local minimum, which is the drawback of other methods like [scipy.optimize.curve_fit](https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.curve%5Ffit.html) whose fitting results strongly depend on the initial values given by the user) and a robust estimation of the error. <br>

I am a heavy user of RADEX, but know little about MCMC. However, it seems that we can still run a basic MCMC fitting code without a rich knowledge about how MCMC works. It is never a bad choice, though, to know more about MCMC before you start using it. This blog mainly refers to [the basic tutorial of emcee](https://emcee.readthedocs.io/en/stable/tutorials/line/), the [radex_emcee](https://github.com/yangcht/radex_emcee) code written by Chentao Yang, and *my private conversation with my roomate*. I do not guarantee that everything in this blog is correct. 

## Prerequisites
The following codes are run in Jupyter Notebook. Other packages you may need are: 
* [emcee](https://emcee.readthedocs.io/en/stable/) to run MCMC and [corner](https://corner.readthedocs.io/en/latest/) to make corner plots.
* a python interface of RADEX. I choose [spectralradex](https://spectralradex.readthedocs.io/en/latest/) (Note that you must not use [pandas](https://pandas.pydata.org/)>2.0 with spectralradex. See [this issue](https://github.com/uclchem/SpectralRadex/issues/9) for details.), and [myRadex](https://github.com/fjdu/myRadex) is also a good choice. You can also write a simple script to run RADEX in python. <br>
 
We first import all the packaged we will use in the code:
```python
import numpy as np
import matplotlib.pyplot as plt
from spectralradex import radex
from multiprocessing import Pool
import time
import emcee 
import corner
from random import uniform
```

## The likelihood function
We need to define a lilelihood function which we want to maximize with MCMC. It is a Gaussian like:
$$\ln p = -\frac{1}{2} \sum_n \left[ \frac{ (\text{model}-\text{obs})^2 }{ \text{sigma}^2 }  + \ln \text{sigma}^2 \right]$$
where


